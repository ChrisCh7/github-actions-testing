name: Create Release Branches

on:
  workflow_dispatch:
    inputs:
      release_number:
        description: 'Number of the release (e.g. 2.14.0)'
        required: true
        type: string
      repositories:
        description: 'Comma-separated list of repositories to process (e.g. org/repo1,org/repo2).'
        required: true
        type: string

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Prepare matrix JSON and validate inputs
        id: set-matrix
        uses: actions/github-script@v8
        env:
          RELEASE_NUMBER: ${{ github.event.inputs.release_number }}
          REPOSITORIES: ${{ github.event.inputs.repositories }}
        with:
          script: |
            const releaseNumber = process.env.RELEASE_NUMBER;
            const repositoriesRaw = process.env.REPOSITORIES;

            core.info(`Received release_number: '${releaseNumber}'`);
            core.info(`Received repositories: '${repositoriesRaw}'`);

            // Validate release_number: strictly X.Y.Z where X, Y, Z are numbers
            const releaseRegex = /^[0-9]+\.[0-9]+\.[0-9]+$/;
            if (!releaseRegex.test(releaseNumber)) {
              core.setFailed(`release_number must be in the format X.Y.Z where X, Y, and Z are numbers (e.g. 2.14.0). Got: '${releaseNumber}'`);
              return;
            }

            // Validate repositories: non-empty, one or more owner/repo entries separated by commas
            if (!repositoriesRaw || repositoriesRaw.trim().length === 0) {
              core.setFailed('repositories input is required and cannot be empty.');
              return;
            }

            const repos = repositoriesRaw
              .split(',')
              .map(repo => repo.trim())
              .filter(repo => repo.length > 0);

            if (repos.length === 0) {
              core.setFailed('repositories input must contain at least one owner/repo entry.');
              return;
            }

            const repoRegex = /^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+$/;
            for (const repo of repos) {
              if (!repoRegex.test(repo)) {
                core.setFailed(`Invalid repository entry '${repo}'. ` +
                               "Each entry must be in the format owner/repo and may only contain letters, digits, '.', '_', and '-'. " +
                               "Optional spaces are only allowed around the commas separating the repo entries.");
                return;
              }
            }

            const matrix = JSON.stringify(repos);
            core.info(`Prepared matrix: ${matrix}`);
            core.setOutput('matrix', matrix);
  create-release-branches:
    needs: prepare-matrix
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    name: ${{ matrix.repo }}
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PK }}
          owner: ${{ github.repository_owner }}
      - name: Run create-release-branch action
        uses: ./.github/actions/create-release-branch
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
          RELEASE_NUMBER: ${{ github.event.inputs.release_number }}
          REPOSITORIES_INPUT: ${{ matrix.repo }}
